#!/usr/bin/env ruby
# encoding: utf-8
require_relative 'anecdot'
require 'net/http'
require 'json'

def moscow_time
  (Time.now.utc + 3*60*60).strftime("%H:%M:%S (%d.%m.%Y)")
end

def show_menu(name)
  puts "\n–ß–µ–º –µ—â–µ –º–æ–≥—É –ø–æ–º–æ—á—å, #{name}? –í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç:"
  puts "1. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –∞–Ω–µ–∫–¥–æ—Ç"
  puts "2. –ü–æ–∫–∞–∑–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è"
  puts "3. –ü–æ–∂–µ–ª–∞—Ç—å –¥–æ–±—Ä–æ–≥–æ —É—Ç—Ä–∞"
  puts "4. –ü–æ–∂–µ–ª–∞—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏"
  puts "5. –ü–æ–º–æ—â—å"
  puts "6. –ü–æ–∑–¥—Ä–∞–≤–∏—Ç—å —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è"
  puts "7. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–≥–æ–¥—É"
  puts "8. –í—ã—Ö–æ–¥"
end

def show_joke_categories
  puts "\n–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∞–Ω–µ–∫–¥–æ—Ç–∞:"
  Anecdote::CATEGORIES.each do |num, category|
    puts "#{num}. #{category}"
  end
  puts "0. –õ—é–±–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"
end

def get_petersburg_weather
  begin
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Open-Meteo API –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    url = URI("https://api.open-meteo.com/v1/forecast?latitude=59.94&longitude=30.31&current_weather=true")
    response = Net::HTTP.get(url)
    data = JSON.parse(response)
    
    if data['current_weather']
      temp = data['current_weather']['temperature']
      wind = data['current_weather']['windspeed']
      weather_code = data['current_weather']['weathercode']
      
      # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–¥ –ø–æ–≥–æ–¥—ã –≤ —Ç–µ–∫—Å—Ç
      weather_desc = case weather_code
                    when 0 then "–Ø—Å–Ω–æ ‚òÄÔ∏è"
                    when 1..3 then "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å ‚õÖ"
                    when 45..48 then "–¢—É–º–∞–Ω üå´Ô∏è"
                    when 51..67 then "–î–æ–∂–¥—å üåßÔ∏è"
                    when 71..77 then "–°–Ω–µ–≥ ‚ùÑÔ∏è"
                    when 80..82 then "–õ–∏–≤–µ–Ω—å üåßÔ∏è"
                    when 85..86 then "–°–Ω–µ–≥–æ–ø–∞–¥ ‚ùÑÔ∏è"
                    when 95..99 then "–ì—Ä–æ–∑–∞ ‚õàÔ∏è"
                    else "–û–±–ª–∞—á–Ω–æ ‚òÅÔ∏è"
                    end
      
      "\n–ü–æ–≥–æ–¥–∞ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ (#{Time.now.strftime('%d.%m.%Y %H:%M')}):\n" +
      "‚òÅÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ: #{weather_desc}\n" +
      "üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: #{temp.round}¬∞C\n" +
      "üå¨ –í–µ—Ç–µ—Ä: #{wind.round(1)} –º/—Å"
    else
      "\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ. –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    end
  rescue => e
    "\n–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã: #{e.message}"
  end
end

def main_menu(name)
  loop do
    show_menu(name)
    choice = gets.chomp

    case choice
    when "1"
      puts "\n–ò—â—É –ª—É—á—à–∏–π –∞–Ω–µ–∫–¥–æ—Ç –¥–ª—è —Ç–µ–±—è..."
      if joke = Anecdote.get_random_joke
        puts "\n#{joke}"
      else
        puts "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–Ω–µ–∫–¥–æ—Ç üòî"
      end
      puts "\n–ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
    when "2"
      puts "\n–¢–µ–∫—É—â–µ–µ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è: #{moscow_time}"
      puts "\n–ß—Ç–æ-—Ç–æ –µ—â–µ?"
    when "3"
      puts "\n#{name}, –∂–µ–ª–∞—é —Ç–µ–±–µ —Å–∞–º–æ–≥–æ —Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ —É—Ç—Ä–∞! üåû"
      puts "–ü—É—Å—Ç—å –¥–µ–Ω—å –Ω–∞—á–Ω—ë—Ç—Å—è —Å —Ö–æ—Ä–æ—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –ø—Ä–∏—è—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π!"
      puts "\n–ú–æ–≥—É –µ—â–µ —á–µ–º-—Ç–æ –ø–æ–º–æ—á—å?"
    when "4"
      puts "\n–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏, #{name}! üåô"
      puts "–ü—É—Å—Ç—å —Ç–µ–±–µ —Å–Ω—è—Ç—Å—è –ø—Ä–∏—è—Ç–Ω—ã–µ —Å–Ω—ã, –∞ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å –±—É–¥–µ—Ç –µ—â—ë –ª—É—á—à–µ!"
      puts "\n–•–æ—á–µ—à—å —Å–∫–∞–∑–∫—É –Ω–∞ –Ω–æ—á—å? (–¥–∞/–Ω–µ—Ç)"
      answer = gets.chomp.downcase
      if answer == "–¥–∞"
        puts "\n–ñ–∏–ª-–±—ã–ª –º–∞–ª–µ–Ω—å–∫–∏–π —ë–∂–∏–∫. –ö–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –æ–Ω –∑–∞–≤–æ—Ä–∞—á–∏–≤–∞–ª—Å—è –≤ –ª–∏—Å—Ç–∏–∫, –∫–∞–∫ –≤ –æ–¥–µ—è–ª–∫–æ, –∏ –∑–∞—Å—ã–ø–∞–ª –ø–æ–¥ —à—ë–ø–æ—Ç –≤–µ—Ç—Ä–∞. üåø‚ú® –ó–≤—ë–∑–¥—ã —Å–≤–µ—Ç–∏–ª–∏ –µ–º—É –≤ –æ–∫–æ—à–∫–æ, –∞ –ª—É–Ω–∞ –ø–µ–ª–∞ –∫–æ–ª—ã–±–µ–ª—å–Ω—É—é. –°–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤, #{name}!"
      end
      puts "\n–ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
    when "5"
      puts "\n–Ø –º–æ–≥—É:"
      puts "- –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –∞–Ω–µ–∫–¥–æ—Ç (–ø—É–Ω–∫—Ç 1)"
      puts "- –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ú–æ—Å–∫–≤–µ (–ø—É–Ω–∫—Ç 2)"
      puts "- –ü–æ–∂–µ–ª–∞—Ç—å –¥–æ–±—Ä–æ–≥–æ —É—Ç—Ä–∞ (–ø—É–Ω–∫—Ç 3)"
      puts "- –ü–æ–∂–µ–ª–∞—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏ (–ø—É–Ω–∫—Ç 4)"
      puts "- –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–≥–æ–¥—É (–ø—É–Ω–∫—Ç 7)"
      puts "- –í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–ø—É–Ω–∫—Ç 8)"
      puts "\n–ß—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
    when "6"
      puts "\n#{name}, –ø–æ–∑–¥—Ä–∞–≤–ª—è—é —Ç–µ–±—è —Å –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è! üéâ"
      puts "       #{'*' * (name.length + 6)}"
      puts "      | #{name} |"
      puts "       #{'*' * (name.length + 6)}"
      puts "\n–ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
    when "7"
      puts get_petersburg_weather
      puts "\n–ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?"
    when "8"
      puts "\n–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–æ–π, #{name}! –î–æ —Å–≤–∏–¥–∞–Ω–∏—è! üëã"
      exit
    else
      puts "\n–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä –∏–∑ –º–µ–Ω—é."
    end
  end
end

puts "–ü—Ä–∏–≤–µ—Ç! –Ø - —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?"
name = gets.chomp

puts "\n–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, #{name}! –Ø –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –∞–Ω–µ–∫–¥–æ—Ç, –ø–æ–∫–∞–∑–∞—Ç—å –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è, –ø–æ–∂–µ–ª–∞—Ç—å –¥–æ–±—Ä–æ–≥–æ —É—Ç—Ä–∞ –∏–ª–∏ —Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏, –∞ —Ç–∞–∫–∂–µ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è. –ß–µ–º —Ç—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –∑–∞–Ω—è–ª—Å—è?"
main_menu(name)